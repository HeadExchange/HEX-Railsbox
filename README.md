# HEX-Railsbox

## Development

Для развёртывания виртальной машины, аналогичной серверу приложения, нужно скопировать папку ```provision``` и ```Vagrantfile``` в папку проекта.

В папке проекта выполнить команду:

```vagrant up```

И пойти пить чай. Пока вы пьёте чай, скачается образ Ubuntu, соответсвующий установленному на сервере, установятся все необходимые пакеты, правильная версия Ruby.

После всего свершившегося можно зайти на виртуалку командой

``` vagrant ssh ```

и запустить установку гемов

``` bundle install ```

и продолжить пить чай.

Пред запуском приложения запустить миграции и остальное что нужно для приложения.

Приложение же запускать командой

``` rails server -b 0.0.0.0 ```

Это для версий ```rails >= 4.2```, т.к. в ней по умолчанию сервер запускается с адресом localhost (127.0.0.1) из-за чего приложение не может быть доступно из вне (из ваше ОС, где вы эту виртуалку создали). В более младших версиях ``` rails ``` приложение по-умолчанию запускается с адресом ```0.0.0.0```.

## Production

Данный инструмент устанавливает все необходимые пакеты в Ubuntu, настраивает PostgreSQL, создаёт папку для проекта и файлы database.yml и secrets.yml

Для установки нужно склонировать репо себе в папку.
Добавить в папку keys свой публичный ключ.

Затем в командной строке переходим в каталог ```provision``` и выполняем команду

```ansible-playbook -i46.78.90.111, production.yml```

Где ```46.78.90.111``` нужно заменить на IP-адрес сервера на который будет производиться деплой.

В начале выполнения нужно будет ввести желаемые
* версию руби
* имя приложение
* домен сайта приложения

Если нужна только инициализация сервера, выполняем:

```ansible-playbook -i46.78.90.111, production-init.yml```

Если нужна только настройка окружения для приложения, выполняем:

```ansible-playbook -i46.78.90.111, production-app.yml```

### Puma auto start

Для того, чтобы приложение корректно стартовало после перезапуска сервера, нужно в `deploy.rb` добавить следующие строки:

```ruby
set :puma_init_active_record, true
set :puma_conf, -> { File.join(shared_path, 'config', 'puma.rb') }
```

Также проследить, что создавалась символьная ссылка на файл конфигурации

```ruby
set :linked_files, fetch(:linked_files, []).push('config/database.yml', 'config/secrets.yml', 'config/puma.rb')
```

Перед деплоем выполнить

```
cap production puma:config
```

За основу взяты статьи:
* https://mkdev.me/posts/nastroyka-i-deploy-rails-prilozheniy-pri-pomoschi-ansible-i-capistrano
* http://habrahabr.ru/company/selectel/blog/196620/
